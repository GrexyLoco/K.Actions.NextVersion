name: ðŸ§ª Test K.Actions.NextVersion

on:
  push:
    branches: [ main, develop, feature/*, bugfix/*, major/*, refactor/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-versioning:
    name: ðŸ”„ Test Version Detection
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        branch-pattern:
          - { name: "feature/test", expected: "minor" }
          - { name: "bugfix/test", expected: "patch" }
          - { name: "major/test", expected: "major" }
          - { name: "refactor/test", expected: "patch" }
        
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Test Version Detection
        id: version
        uses: ./
        with:
          manifestPath: './TestModule.psd1'
          branchName: ${{ matrix.branch-pattern.name }}
          commitMessage: 'Test commit message'

      - name: âœ… Validate Results
        run: |
          echo "ðŸ” Testing branch pattern: ${{ matrix.branch-pattern.name }}"
          echo "ðŸ“‹ Expected bump type: ${{ matrix.branch-pattern.expected }}"
          echo "ðŸ“Š Actual bump type: ${{ steps.version.outputs.bumpType }}"
          echo "ðŸ“ˆ Version progression: ${{ steps.version.outputs.currentVersion }} â†’ ${{ steps.version.outputs.newVersion }}"
          
          if [ "${{ steps.version.outputs.bumpType }}" = "${{ matrix.branch-pattern.expected }}" ]; then
            echo "âœ… SUCCESS: Bump type matches expectation"
          else
            echo "âŒ FAILURE: Expected ${{ matrix.branch-pattern.expected }}, got ${{ steps.version.outputs.bumpType }}"
            exit 1
          fi

  test-breaking-changes:
    name: ðŸ’¥ Test Breaking Change Detection  
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ§ª Test Breaking Change Override
        id: breaking
        uses: ./
        with:
          manifestPath: './TestModule.psd1'
          branchName: 'bugfix/test-fix'
          commitMessage: 'BREAKING: This should trigger major bump'

      - name: âœ… Validate Breaking Change Detection
        run: |
          echo "ðŸ” Testing breaking change override"
          echo "ðŸ“‹ Expected bump type: major"
          echo "ðŸ“Š Actual bump type: ${{ steps.breaking.outputs.bumpType }}"
          
          if [ "${{ steps.breaking.outputs.bumpType }}" = "major" ]; then
            echo "âœ… SUCCESS: Breaking change correctly detected"
          else
            echo "âŒ FAILURE: Breaking change not detected, got ${{ steps.breaking.outputs.bumpType }}"
            exit 1
          fi

  test-auto-discovery:
    name: ðŸ”Ž Test Auto-Discovery
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Test Auto-Discovery Mode
        id: auto
        uses: ./
        # Keine manifestPath angegeben - sollte TestModule.psd1 automatisch finden

      - name: âœ… Validate Auto-Discovery
        run: |
          echo "ðŸ” Testing auto-discovery functionality"
          echo "ðŸ“Š Found version: ${{ steps.auto.outputs.currentVersion }}"
          echo "ðŸ“‹ Bump type: ${{ steps.auto.outputs.bumpType }}"
          echo "ðŸ“ˆ New version: ${{ steps.auto.outputs.newVersion }}"
          
          if [ -n "${{ steps.auto.outputs.currentVersion }}" ]; then
            echo "âœ… SUCCESS: Auto-discovery found manifest"
          else
            echo "âŒ FAILURE: Auto-discovery failed"
            exit 1
          fi

  integration-test:
    name: ðŸ”— Integration Test
    runs-on: ubuntu-latest
    needs: [test-versioning, test-breaking-changes, test-auto-discovery]
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸš€ Full Integration Test
        id: integration
        uses: ./
        with:
          manifestPath: './TestModule.psd1'
          branchName: ${{ github.ref_name }}
          commitMessage: ${{ github.event.head_commit.message || 'Integration test commit' }}

      - name: ðŸ“‹ Display Complete Results
        run: |
          echo "## ðŸŽ¯ K.Actions.NextVersion Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Current Version | \`${{ steps.integration.outputs.currentVersion }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Bump Type | \`${{ steps.integration.outputs.bumpType }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| New Version | \`${{ steps.integration.outputs.newVersion }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.event.head_commit.message || 'N/A' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **All tests passed successfully!**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸŽ‰ Success Notification
        run: |
          echo "ðŸŽ‰ ALL TESTS PASSED!"
          echo "âœ… Version detection working correctly"
          echo "âœ… Breaking change detection working correctly" 
          echo "âœ… Auto-discovery working correctly"
          echo "âœ… Integration test completed successfully"
